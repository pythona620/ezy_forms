var de=Object.defineProperty;var J=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var M=(f,i,u)=>i in f?de(f,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):f[i]=u,I=(f,i)=>{for(var u in i||(i={}))me.call(i,u)&&M(f,u,i[u]);if(J)for(var u of J(i))ve.call(i,u)&&M(f,u,i[u]);return f};import{_ as fe,q as pe,u as _e,e as E,d as a,w as ge,o as _,c as g,b as s,t as h,a as W,G as he,P as ye,C as be,D as we,H as U,i as R,x as N,z as qe,B as Re,E as ke,L as Ce,k as y,l as b,n as O}from"./index-LfV3iEDw.js";const Se={class:"d-flex justify-content-between align-items-center py-2"},Ne={class:"m-0 font-11 pt-1"},Le={class:"mt-2"},Pe={class:"modal fade",id:"viewRequest","data-bs-backdrop":"static","data-bs-keyboard":"false",tabindex:"-1","aria-labelledby":"viewRequestLabel","aria-hidden":"true"},Ee={class:"modal-dialog modal-dialog-centered modal-lg"},Oe={class:"modal-content"},$e={class:"modal-header"},Ae={class:"modal-title font-13",id:"viewRequestLabel"},Fe={class:"p-2"},Te={class:"activity-log-container"},xe={class:"activity-log-content"},Ve={class:"font-12 mb-1"},Be={class:"strong-content"},De={class:"strong-content"},Je={class:"strong-content"},Me={key:0},Ie={key:1,class:"strong-content"},We={key:0,class:"form-floating p-1"},Ue={key:0,class:"font-11 text-danger ps-1"},He={__name:"HistoryComp",setup(f){const i=pe(),u=_e(),H=E(()=>ke.value),$=a({business_unit:""}),n=a({limitPageLength:20,limit_start:0,filters:[]}),L=a(0),j=a([]),z=a([]),G=a([]);a([]);const Q=a(""),k=a([]),A=a([]);a(!1);const F=a([{th:"Request ID",td_key:"name"},{th:"Requested By",td_key:"requested_by"},{th:"Requested Department",td_key:"role"},{th:"Approval Status",td_key:"status"},{th:"Workflow Status",td_key:"assigned_to_users"}]),X=a([{name:"View Request",icon:"fa-solid fa-eye"}]),w=a([]),c=a({}),T=a(null),x=a([]),P=a("");a([]);const Y=a([]);a(!1),a(!1);const V=a([]);function Z(){y.post(b.approvedByMe).then(e=>{V.value=e.message,p()}).catch(e=>{console.log(e)})}function K(e,t){var r,l,o;if(t.name==="View Request")if(e){c.value=I({},e),Q.value=c.value.current_level,T.value=Ce((l=JSON.parse((r=c.value)==null?void 0:r.json_columns))==null?void 0:l.fields),Y.value=JSON.parse((o=c.value)==null?void 0:o.json_columns).child_table_fields;const m=[["wf_generated_request_id","like",`%${c.value.name}%`]],v={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(m),order_by:`\`tab${c.value.doctype_name}\`.\`creation\` desc`};y.get(`${b.resource}${c.value.doctype_name}`,{params:v}).then(d=>{d.data&&(x.value=d.data[0],ne(x.value,T.value),y.get(`${b.resource}${c.value.doctype_name}/${d.data[0].name}`).then(q=>{const D=Object.keys(q.data).filter(S=>Array.isArray(q.data[S]));D.length&&(A.value={},D.forEach(S=>{A.value[S]=q.data[S]||[]}))}).catch(q=>{console.error("Error fetching data for :",q)}))}).catch(d=>{console.error("Error fetching categories data:",d)}),y.get(`${b.resource}${O.WFActivityLog}/${c.value.name}`).then(d=>{d.data&&(k.value=d.data.reason||[])}).catch(d=>{console.error("Error fetching activity data:",d)}),new bootstrap.Modal(document.getElementById("viewRequest"),{}).show()}else console.warn(" There is no form fields ")}function ee(e){i.push({name:"ApproveRequest",query:{routepath:u.path,name:e.name,doctype_name:e.doctype_name,type:"myapprovals",readOnly:"true"}})}const te=E(()=>k.value.some(e=>e.action==="Request Cancelled")),ae=e=>e?new Date(e).toLocaleDateString("en-GB"):"N/A",se=e=>e?{"Request Cancelled":"cancelled","Request Raised":"raised"}[e]||e.toLowerCase():"performed an action on",C=a(!0),oe=()=>{P.value.trim()!==""&&(C.value=!0)};function ne(e,t){t.forEach(r=>{r.sections.forEach(l=>{l.rows.forEach(o=>{o.columns.forEach(m=>{m.fields.forEach(v=>{e!=null&&e.hasOwnProperty(v==null?void 0:v.fieldname)&&(v.value=e[v==null?void 0:v.fieldname])})})})})})}function le(){C.value=!0}const re=e=>{n.value.limitPageLength=e,n.value.limit_start=0,n.value.filters.length?p(n.value.filters):p()},ie=([e,t])=>{n.value.limitPageLength=e,n.value.limit_start=t,n.value.filters.length?p(n.value.filters):p()};a([]);const B=a(null);function ue(e){clearTimeout(B.value),B.value=setTimeout(()=>{n.value.filters=[],F.value.forEach(t=>{const r=t.td_key;e[r]&&n.value.filters.push([r,"like",`%${e[r]}%`])}),n.value.filters.length?(n.value.limit_start=0,p(n.value.filters)):p()},500)}function p(e){JSON.parse(localStorage.getItem("employeeData"));const t=[["property","like",`%${$.value.business_unit}%`],["name","in",V.value]];e&&(t.push(...e),console.log(e));const r={fields:JSON.stringify(["*"]),limit_page_length:n.value.limitPageLength,limit_start:n.value.limit_start,filters:JSON.stringify(t),order_by:"`tabWF Workflow Requests`.`creation` desc"},l={fields:JSON.stringify(["count(name) AS total_count"]),limitPageLength:"None",filters:JSON.stringify(t)};y.get(`${b.resource}${O.WFWorkflowRequests}`,{params:l}).then(o=>{L.value=o.data[0].total_count}).catch(o=>{console.error("Error fetching total count:",o)}),y.get(`${b.resource}${O.WFWorkflowRequests}`,{params:r}).then(o=>{n.value.limit_start===0?(w.value=o.data,j.value=[...new Set(o.data.map(m=>m.name))],z.value=[...new Set(o.data.map(m=>m.doctype_name))],G.value=[...new Set(o.data.map(m=>m.status))]):w.value=w.value.concat(o.data)}).catch(o=>{console.error("Error fetching records:",o)})}const ce=E(()=>({name:{type:"input"},requested_by:{type:"input"},role:{type:"input"},status:{type:"select",options:["In Progress","Completed","Request Cancelled"]}}));return ge(H,e=>{$.value.business_unit=e,e.length&&Z()},{immediate:!0}),(e,t)=>{var r;return _(),g("div",null,[s("div",Se,[s("div",null,[t[1]||(t[1]=s("h1",{class:"m-0 font-13"},"My Approval Forms",-1)),s("p",Ne,h(L.value)+" Forms",1)])]),s("div",Le,[W(he,{tHeaders:F.value,tData:w.value,isAction:"true",viewType:"viewPdf",isCheckbox:"true",onUpdateFilters:ue,"field-mapping":ce.value,onCellClick:ee,isFiltersoption:"true",actions:X.value,onActionClicked:K},null,8,["tHeaders","tData","field-mapping","actions"]),W(ye,{currentRecords:w.value.length,totalRecords:L.value,onUpdateValue:re,onLimitStart:ie},null,8,["currentRecords","totalRecords"])]),s("div",Pe,[s("div",Ee,[s("div",Oe,[s("div",$e,[s("h5",Ae," Request Id: "+h((r=c.value.name)==null?void 0:r.replace(/_/g," ")),1),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal",onClick:le,"aria-label":"Close"})]),t[8]||(t[8]=s("div",{class:"modal-body approvermodalbody"},null,-1)),s("div",Fe,[s("div",Te,[(_(!0),g(be,null,we(k.value,(l,o)=>(_(),g("div",{key:o,class:U(["activity-log-item",{"last-item":o===k.value.length-1}])},[t[5]||(t[5]=s("div",{class:"activity-log-dot"},null,-1)),t[6]||(t[6]=R("def add_roles_to_wf_requestors ")),s("div",xe,[s("p",Ve,[t[2]||(t[2]=R(" On ")),s("strong",Be,h(ae(l.creation)),1),t[3]||(t[3]=R(", ")),s("strong",De,h(l.user_name),1),R(" ("+h(l.role)+") has ",1),s("strong",Je,h(se(l.action)),1),t[4]||(t[4]=R(" the request")),o!==0&&l.reason?(_(),g("span",Me,"with the comments:")):N("",!0),o!==0&&l.reason?(_(),g("strong",Ie,h(l.reason||"N/A"),1)):N("",!0)])])],2))),128))]),te.value?N("",!0):(_(),g("div",We,[qe(s("textarea",{class:U(["form-control font-12",{"is-invalid":!C.value}]),placeholder:"Leave a comment here",id:"floatingTextarea",onInput:oe,"onUpdate:modelValue":t[0]||(t[0]=l=>P.value=l)},null,34),[[Re,P.value]]),t[7]||(t[7]=s("label",{class:"font-11",for:"floatingTextarea"},"Comments..",-1)),C.value?N("",!0):(_(),g("span",Ue,"Please enter comments**"))]))])])])])])}}},Qe=fe(He,[["__scopeId","data-v-213f0931"]]);export{Qe as default};
