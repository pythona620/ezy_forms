var qe=Object.defineProperty;var z=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var G=(q,d,v)=>d in q?qe(q,d,{enumerable:!0,configurable:!0,writable:!0,value:v}):q[d]=v,H=(q,d)=>{for(var v in d||(d={}))ke.call(d,v)&&G(q,v,d[v]);if(z)for(var v of z(d))Re.call(d,v)&&G(q,v,d[v]);return q};import{_ as we,L as Ce,u as $e,e as D,E as Se,r as n,i as Ae,w as Ee,o as m,c as f,d as s,t as R,b as K,G as Fe,P as Ne,C as Oe,D as Le,n as Q,l as E,s as b,x as Pe,B as Ie,K as X,f as _,g,W as De,h as M,m as L}from"./index-DxID15hf.js";const Me={class:"d-flex justify-content-between align-items-center py-2"},xe={class:"m-0 font-11 pt-1"},Te={class:"mt-2"},Be={class:"modal fade",id:"viewRequest","data-bs-backdrop":"static","data-bs-keyboard":"false",tabindex:"-1","aria-labelledby":"viewRequestLabel","aria-hidden":"true"},je={class:"modal-dialog modal-dialog-centered modal-lg"},Ve={class:"modal-content"},Je={class:"modal-header"},We={class:"modal-title font-13",id:"viewRequestLabel"},Ue={class:"p-2"},ze={class:"activity-log-container"},Ge={class:"activity-log-content"},He={class:"font-12 mb-1"},Ke={class:"strong-content"},Qe={class:"strong-content"},Xe={class:"strong-content"},Ye={key:0},Ze={key:1,class:"strong-content"},et={key:0,class:"form-floating p-1"},tt={key:0,class:"font-11 text-danger ps-1"},at={class:"modal-footer"},st={key:0,class:"d-flex justify-content-between align-items-center mt-3 gap-2"},ot=["disabled"],nt={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},lt={key:1},rt=["disabled"],it={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},ut={key:1},ct={__name:"ReceivedForMe",setup(q){const d=Ce(),v=$e(),Y=D(()=>Se.value),x=n({business_unit:""}),r=n({limitPageLength:20,limit_start:0,filters:[]}),P=n(0),Z=n([]),ee=n([]),te=n([]),w=n([]),ae=n(""),F=n([]),T=n([]);n(!1);const B=n([{th:"Request ID",td_key:"name"},{th:"Requested By",td_key:"requested_by"},{th:"Requested on",td_key:"requested_on"},{th:"Requested Department",td_key:"role"},{th:"Approval Status",td_key:"status"},{th:"Pending With",td_key:"assigned_to_users"},{th:"Linked ID",td_key:"linked_form_id"}]),se=n([{name:"View Request",icon:"fa-solid fa-eye"}]),C=n([]),l=n({}),j=n(null),N=n([]),y=n(""),I=n([]),oe=n([]),$=n(!1),S=n(!1);Ae(()=>{const t=localStorage.getItem("employeeData");I.value=JSON.parse(t)});const V=n([]);function ne(){_.post(g.view_only_reportee).then(t=>{V.value=t.message,h(r.value.filters)}).catch(t=>{console.log(t)})}function le(t,e){var o,a,i;if(e.name==="View Request")if(t){l.value=H({},t),ae.value=l.value.current_level,j.value=De((a=JSON.parse((o=l.value)==null?void 0:o.json_columns))==null?void 0:a.fields),oe.value=JSON.parse((i=l.value)==null?void 0:i.json_columns).child_table_fields;const u=[["wf_generated_request_id","like",`%${l.value.name}%`]],c={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(u),order_by:`\`tab${l.value.doctype_name}\`.\`creation\` desc`};_.get(`${g.resource}${l.value.doctype_name}`,{params:c}).then(p=>{p.data&&(N.value=p.data[0],pe(N.value,j.value),_.get(`${g.resource}${l.value.doctype_name}/${p.data[0].name}`).then(A=>{const U=Object.keys(A.data).filter(O=>Array.isArray(A.data[O]));U.length&&(T.value={},U.forEach(O=>{T.value[O]=A.data[O]||[]}))}).catch(A=>{console.error("Error fetching data for :",A)}))}).catch(p=>{console.error("Error fetching categories data:",p)}),_.get(`${g.resource}${M.WFActivityLog}/${l.value.name}`).then(p=>{p.data&&(F.value=p.data.reason||[])}).catch(p=>{console.error("Error fetching activity data:",p)}),new bootstrap.Modal(document.getElementById("viewRequest"),{}).show()}else console.warn(" There is no form fields ")}function re(t,e,o){o==="view"&&d.push({name:"ApproveRequest",query:{routepath:v.path,name:t.name,doctype_name:t.doctype_name,type:"mytasks",designation:I.value}}),o==="td_key"&&t.linked_form_id&&d.push({name:"ApproveRequest",query:{routepath:v.path,name:t.linked_form_id,business_unit:t.property,type:"linkedForm",readOnly:"true"}})}const J=D(()=>F.value.some(t=>t.action==="Request Cancelled")),ie=t=>t?new Date(t).toLocaleDateString("en-GB"):"N/A",ue=t=>t?{"Request Cancelled":"cancelled","Request Raised":"raised"}[t]||t.toLowerCase():"performed an action on",k=n(!0),ce=()=>{y.value.trim()!==""&&(k.value=!0)};function de(t,e){if(y.value.trim()===""){k.value=!1;return}k.value=!0,$.value=!0;let o={};w.value.length&&w.value.map(a=>{o[a.fieldname]=a.value}),_.put(`${g.resource}${l.value.doctype_name}/${N.value.name}`,o).then(a=>{a!=null&&a.data&&ve(t,e)}).catch(a=>{console.error("Error submitting form:",a)})}function ve(t,e){let o={property:l.value.property,doctype:l.value.doctype_name,request_ids:[l.value.name],reason:y.value,action:e,files:null,cluster_name:null,url_for_approval_id:"",current_level:l.value.current_level};_.post(g.requestApproval,{request_details:[o]}).then(a=>{var i;((i=a==null?void 0:a.message)==null?void 0:i.success)===!0?(L.success(`Request ${e}ed`,{autoClose:1e3,transition:"zoom"}),bootstrap.Modal.getInstance(document.getElementById("viewRequest")).hide(),y.value="",h()):L.error(`Failed to ${e} request`,{autoClose:1e3,transition:"zoom"})}).catch(a=>{console.error("Error processing request:",a)}).finally(()=>{$.value=!1})}function me(t,e){if(y.value.trim()===""){k.value=!1;return}k.value=!0,S.value=!0;let o={};w.value.length&&w.value.map(a=>{o[a.fieldname]=a.value}),_.put(`${g.resource}${l.value.doctype_name}/${N.value.name}`,o).then(a=>{a!=null&&a.data&&(bootstrap.Modal.getInstance(document.getElementById("viewRequest")).hide(),fe(t,e))})}function fe(t,e){let o={property:l.value.property,doctype:l.value.doctype_name,request_id:l.value.name,reason:y.value,action:e,files:[],url_for_cancelling_id:"",current_level:l.value.current_level};_.post(g.wf_cancelling_request,o).then(a=>{a!=null&&a.message&&(y.value="",L.success(`${e}`,{autoClose:1e3,transition:"zoom"}),bootstrap.Modal.getInstance(document.getElementById("viewRequest")).hide(),h())}).catch(a=>{console.error("Error processing cancellation:",a),L.error("An error occurred while processing your request.",{autoClose:1e3,transition:"zoom"})}).finally(()=>{S.value=!1})}function pe(t,e){e.forEach(o=>{o.sections.forEach(a=>{a.rows.forEach(i=>{i.columns.forEach(u=>{u.fields.forEach(c=>{t!=null&&t.hasOwnProperty(c==null?void 0:c.fieldname)&&(c.value=t[c==null?void 0:c.fieldname])})})})})})}function _e(){k.value=!0}const ge=t=>{r.value.limitPageLength=t,r.value.limit_start=0,r.value.filters.length?h(r.value.filters):h()},ye=([t,e])=>{r.value.limitPageLength=t,r.value.limit_start=e,r.value.filters.length?h(r.value.filters):h()};n([]);const W=n(null);function he(t){clearTimeout(W.value),W.value=setTimeout(()=>{r.value.filters=[],B.value.forEach(e=>{const o=e.td_key;t[o]&&r.value.filters.push([o,"like",`%${t[o]}%`])}),r.value.filters.length?(r.value.limit_start=0,h(r.value.filters)):h()},500)}function h(t){const e=JSON.parse(localStorage.getItem("employeeData"));I.value=e.designation;const o=[["assigned_to_users","like",`%${e==null?void 0:e.designation}%`],["property","like",`%${x.value.business_unit}%`],["status","!=","Request Cancelled"],["name","in",V.value],["status","!=","Completed"]];t&&o.push(...t);const a={fields:JSON.stringify(["*"]),limit_page_length:r.value.limitPageLength,limit_start:r.value.limit_start,filters:JSON.stringify(o),order_by:"`tabWF Workflow Requests`.`creation` desc"},i={fields:JSON.stringify(["count(name) AS total_count"]),limitPageLength:"None",filters:JSON.stringify(o)};_.get(`${g.resource}${M.WFWorkflowRequests}`,{params:i}).then(u=>{P.value=u.data[0].total_count}).catch(u=>{console.error("Error fetching total count:",u)}),_.get(`${g.resource}${M.WFWorkflowRequests}`,{params:a}).then(u=>{r.value.limit_start===0?(C.value=u.data,Z.value=[...new Set(u.data.map(c=>c.name))],ee.value=[...new Set(u.data.map(c=>c.doctype_name))],te.value=[...new Set(u.data.map(c=>c.status))]):C.value=C.value.concat(u.data)}).catch(u=>{console.error("Error fetching records:",u)})}const be=D(()=>({name:{type:"input"},requested_by:{type:"input"},role:{type:"input"},requested_on:{type:"date"},status:{type:"select",options:["Request Raised","In Progress"]}}));return Ee(Y,t=>{x.value.business_unit=t,t.length&&ne()},{immediate:!0}),(t,e)=>{var o;return m(),f("div",null,[s("div",Me,[s("div",null,[e[3]||(e[3]=s("h1",{class:"m-0 font-13"},"Requests Assigned to me",-1)),s("p",xe,R(P.value)+" request",1)])]),s("div",Te,[K(Fe,{tHeaders:B.value,tData:C.value,isAction:"true",viewType:"viewPdf",isCheckbox:"true",onUpdateFilters:he,"field-mapping":be.value,onCellClick:re,isFiltersoption:"true",actions:se.value,onActionClicked:le},null,8,["tHeaders","tData","field-mapping","actions"]),K(Ne,{currentRecords:C.value.length,totalRecords:P.value,onUpdateValue:ge,onLimitStart:ye},null,8,["currentRecords","totalRecords"])]),s("div",Be,[s("div",je,[s("div",Ve,[s("div",Je,[s("h5",We," Request Id: "+R((o=l.value.name)==null?void 0:o.replace(/_/g," ")),1),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal",onClick:_e,"aria-label":"Close"})]),e[12]||(e[12]=s("div",{class:"modal-body approvermodalbody"},null,-1)),s("div",Ue,[s("div",ze,[(m(!0),f(Oe,null,Le(F.value,(a,i)=>(m(),f("div",{key:i,class:Q(["activity-log-item",{"last-item":i===F.value.length-1}])},[e[7]||(e[7]=s("div",{class:"activity-log-dot"},null,-1)),e[8]||(e[8]=E("def add_roles_to_wf_requestors ")),s("div",Ge,[s("p",He,[e[4]||(e[4]=E(" On ")),s("strong",Ke,R(ie(a.creation)),1),e[5]||(e[5]=E(", ")),s("strong",Qe,R(a.user_name),1),E(" ("+R(a.role)+") has ",1),s("strong",Xe,R(ue(a.action)),1),e[6]||(e[6]=E(" the request")),i!==0&&a.reason?(m(),f("span",Ye,"with the comments:")):b("",!0),i!==0&&a.reason?(m(),f("strong",Ze,R(a.reason||"N/A"),1)):b("",!0)])])],2))),128))]),J.value?b("",!0):(m(),f("div",et,[Pe(s("textarea",{class:Q(["form-control font-12",{"is-invalid":!k.value}]),placeholder:"Leave a comment here",id:"floatingTextarea",onInput:ce,"onUpdate:modelValue":e[0]||(e[0]=a=>y.value=a)},null,34),[[Ie,y.value]]),e[9]||(e[9]=s("label",{class:"font-11",for:"floatingTextarea"},"Comments..",-1)),k.value?b("",!0):(m(),f("span",tt,"Please enter comments**"))]))]),s("div",at,[J.value?b("",!0):(m(),f("div",st,[s("div",null,[s("button",{type:"submit",class:"btn btn-outline-danger font-12 py-0 rejectbtn",disabled:S.value,onClick:e[1]||(e[1]=X(a=>me(t.formData,"Request Cancelled"),["prevent"]))},[S.value?(m(),f("span",nt)):b("",!0),S.value?b("",!0):(m(),f("span",lt,e[10]||(e[10]=[s("i",{class:"bi bi-x-lg me-2"},null,-1),s("span",{class:"font-12"},"Reject",-1)])))],8,ot)]),s("div",null,[s("button",{type:"submit",class:"btn btn-success approvebtn",disabled:$.value,onClick:e[2]||(e[2]=X(a=>de(w.value,"Approve"),["prevent"]))},[$.value?(m(),f("span",it)):b("",!0),$.value?b("",!0):(m(),f("span",ut,e[11]||(e[11]=[s("i",{class:"bi bi-check-lg font-15 me-2"},null,-1),s("span",{class:"font-12"},"Approve",-1)])))],8,rt)])]))])])])])])}}},ft=we(ct,[["__scopeId","data-v-37bf5134"]]);export{ft as default};
