var se=Object.defineProperty;var D=Object.getOwnPropertySymbols;var ne=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var T=(v,d,c)=>d in v?se(v,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):v[d]=c,I=(v,d)=>{for(var c in d||(d={}))ne.call(d,c)&&T(v,c,d[c]);if(D)for(var c of D(d))ie.call(d,c)&&T(v,c,d[c]);return v};import{q as le,e as re,d as i,I as de,u as ce,w as ue,f as me,o as N,c as O,b as a,t as w,a as V,_ as fe,P as pe,j as _,z as ve,A as _e,y as ge,E as ye,J as he,l as f,m as p,p as $,n as be}from"./index-DXneRfP_.js";const we={class:"d-flex justify-content-between align-items-center py-2"},ke={class:"m-0 font-11 pt-1"},qe={class:"mt-2"},Re={class:"modal fade",id:"viewRequest","data-bs-backdrop":"static","data-bs-keyboard":"false",tabindex:"-1","aria-labelledby":"viewRequestLabel","aria-hidden":"true"},Pe={class:"modal-dialog modal-dialog-centered modal-lg"},Se={class:"modal-content"},Ee={class:"modal-header py-2 d-block"},Ne={class:"d-flex justify-content-between align-items-center"},Oe={class:"m-0 font-13",id:"viewRequest"},$e={class:""},Ce={class:"activity-log-container"},Fe={class:"activity-log-content"},Le={class:"font-12 mb-1"},xe={class:"strong-content"},Me={class:"strong-content"},Je={class:"strong-content"},Ae={class:"modal fade",id:"pdfView",tabindex:"-1","aria-labelledby":"pdfViewLabel","aria-hidden":"true"},De={class:"modal-dialog modal-xl"},Te={class:"modal-content"},Ie={class:"modal-header py-2 d-block bg-dark text-white"},Ve={class:"d-flex justify-content-between align-items-center"},je={class:""},Be={class:"modal-body pdf-body"},He=["innerHTML"],Ue={__name:"HistoryComp",setup(v){const d=re(()=>ye.value),c=i({business_unit:""}),j=de(),B=ce(),g=i({limitPageLength:"None",limit_start:0}),P=i(0),l=i({}),C=i(null),y=i([]),H=i([]),U=i([]),W=i([]);i([]);const k=i([]),z=i(""),S=i(""),E=i([]),F=i([{th:"Request ID",td_key:"name"},{th:"Form name",td_key:"doctype_name"},{th:"Owner of form",td_key:"role"},{th:"Requested on",td_key:"requested_on"},{th:"Requested department",td_key:"role"},{th:"Approval Status",td_key:"status"}]),G=i({requested_on:{type:"input"},name:{type:"input"},doctype_name:{type:"input"}}),K=i([{name:"View Request",icon:"fa-solid fa-eye"},{name:"PDF Format",icon:"bi bi-filetype-pdf"}]);function Q(t,e){var s;if(e.name==="View Request")if(t){l.value=I({},t),z.value=l.value.total_levels,C.value=he(JSON.parse((s=l.value)==null?void 0:s.json_columns).fields);const n=[["wf_generated_request_id","like",`%${l.value.name}%`]],r={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(n),order_by:`\`tab${l.value.doctype_name}\`.\`creation\` desc`};f.get(`${p.resource}${l.value.doctype_name}`,{params:r}).then(o=>{o.data&&(y.value=o.data,ee(y.value[0],C.value))}).catch(o=>{console.error("Error fetching categories data:",o)}),f.get(`${p.resource}${$.WFActivityLog}/${l.value.name}`).then(o=>{o.data&&(E.value=o.data.reason||[])}).catch(o=>{console.error("Error fetching activity data:",o)}),new bootstrap.Modal(document.getElementById("viewRequest"),{}).show()}else console.warn(" There is no form fields ");else if(e.name==="PDF Format"){l.value=t;const n=[["wf_generated_request_id","like",`%${l.value.name}%`]],r={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(n),order_by:`\`tab${l.value.doctype_name}\`.\`creation\` desc`};f.get(`${p.resource}${l.value.doctype_name}`,{params:r}).then(o=>{if(o.data){y.value=o.data;const b={form_short_name:t.doctype_name,name:y.value[0].name,business_unit:d.value};f.post(p.preview_dynamic_form,b).then(u=>{S.value=u.message}).catch(u=>{console.error("Error fetching data:",u)})}}).catch(o=>{console.error("Error fetching categories data:",o)}),new bootstrap.Modal(document.getElementById("pdfView"),{}).show()}}function X(t,e,s){if(s==="view"&&t&&j.push({name:"ApproveRequest",query:{routepath:B.path,name:t.name,doctype_name:t.doctype_name,type:"myforms",readOnly:"true"}}),s==="download"){l.value=t;const n=[["wf_generated_request_id","like",`%${l.value.name}%`]],r={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(n),order_by:`\`tab${l.value.doctype_name}\`.\`creation\` desc`};f.get(`${p.resource}${l.value.doctype_name}`,{params:r}).then(o=>{if(o.data){y.value=o.data;const b={form_short_name:t.doctype_name,name:y.value[0].name};f.post(p.preview_dynamic_form,b).then(u=>{S.value=u.message}).catch(u=>{console.error("Error fetching data:",u)})}}).catch(o=>{console.error("Error fetching categories data:",o)}),new bootstrap.Modal(document.getElementById("pdfView"),{}).show()}}const Y=t=>t?new Date(t).toLocaleDateString("en-GB"):"N/A",Z=t=>t?{"Request Cancelled":"cancelled","Request Raised":"raised"}[t]||t.toLowerCase():"performed an action on";function L(){var e;const t={form_short_name:l.value.doctype_name,name:(e=y.value[0])==null?void 0:e.name,business_unit:d.value};f.post(p.download_pdf_form,t).then(s=>{let n=be+s.message;n=n.replace("/api","");const r=document.createElement("a");r.href=n,r.download=s.message.split("/").pop(),r.click()}).catch(s=>{console.error("Error fetching data:",s)})}function ee(t,e){e.forEach(s=>{s.sections.forEach(n=>{n.rows.forEach(r=>{r.columns.forEach(h=>{h.fields.forEach(o=>{t!=null&&t.hasOwnProperty(o==null?void 0:o.fieldname)&&(o.value=t[o==null?void 0:o.fieldname])})})})})})}const te=t=>{g.value.limitPageLength=t,g.value.limit_start=0,R()},ae=([t,e])=>{g.value.limitPageLength=t,g.value.limit_start=e,R()},x=i(null);function oe(t){clearTimeout(x.value),x.value=setTimeout(()=>{const e=[];F.value.forEach(s=>{const n=s.td_key;t[n]&&e.push(n,"like",`%${t[n]}%`)}),R(e.length?e:void 0)},500)}function R(t){var b,u,M,J;const e=JSON.parse(localStorage.getItem("employeeData")),s=new Date;s.setMonth(s.getMonth()-1);const n=s.toISOString().split("T")[0],r=[["requested_by","like",e.emp_mail_id],["property","like",`%${c.value.business_unit}%`],["status","=","Completed"],["creation",">=",n]];t&&r.push(t);const h={fields:JSON.stringify(["*"]),limit_page_length:(b=g.value)==null?void 0:b.limitPageLength,limit_start:(u=g.value)==null?void 0:u.limit_start,filters:JSON.stringify(r),order_by:"`tabWF Workflow Requests`.`creation` desc"},o={fields:JSON.stringify(["count(name) AS total_count"]),limitPageLength:"None",filters:JSON.stringify(r)};f.get(`${(M=p)==null?void 0:M.resource}${(J=$)==null?void 0:J.WFWorkflowRequests}`,{params:o}).then(m=>{P.value=m.data[0].total_count}).catch(m=>{console.error("Error fetching total count:",m)}),f.get(`${p.resource}${$.WFWorkflowRequests}`,{params:h}).then(m=>{const A=m.data;g.value.limit_start===0?(k.value=A,H.value=[...new Set(m.data.map(q=>q.name))],U.value=[...new Set(m.data.map(q=>q.doctype_name))],W.value=[...new Set(m.data.map(q=>q.status))]):k.value=k.value.concat(A)}).catch(m=>{console.error("Error fetching records:",m)})}return ue(d,t=>{c.value.business_unit=t,t.length&&R()},{immediate:!0}),me(()=>{}),(t,e)=>(N(),O("div",null,[a("div",we,[a("div",null,[e[2]||(e[2]=a("h1",{class:"m-0 font-13"},"History",-1)),a("p",ke,w(P.value)+" request",1)])]),a("div",qe,[V(fe,{tHeaders:F.value,tData:k.value,isAction:"true",viewType:"viewPdf",isCheckbox:"true",onCellClick:X,actions:K.value,onActionClicked:Q,isFiltersoption:"true","field-mapping":G.value,onUpdateFilters:oe},null,8,["tHeaders","tData","actions","field-mapping"]),V(pe,{currentRecords:k.value.length,totalRecords:P.value,onUpdateValue:te,onLimitStart:ae},null,8,["currentRecords","totalRecords"])]),a("div",Re,[a("div",Pe,[a("div",Se,[a("div",Ee,[a("div",Ne,[a("div",null,[a("h5",Oe,"Request Id: "+w(l.value.name),1)]),a("div",$e,[a("button",{button:"button",class:"btn btn-white text-dark font-13",onClick:L},e[3]||(e[3]=[_(" Download Pdf"),a("span",{class:"ms-2"},[a("i",{class:"bi bi-download"})],-1)])),a("button",{type:"button",class:"btn btn-white text-dark font-13",onClick:e[0]||(e[0]=(...s)=>t.closemodal&&t.closemodal(...s)),"data-bs-dismiss":"modal"},e[4]||(e[4]=[_(" Close "),a("i",{class:"bi bi-x"},null,-1)]))])])]),e[9]||(e[9]=a("div",{class:"modal-body approvermodalbody"},null,-1)),a("div",Ce,[(N(!0),O(ve,null,_e(E.value,(s,n)=>(N(),O("div",{key:n,class:ge(["activity-log-item",{"last-item":n===E.value.length-1}])},[e[8]||(e[8]=a("div",{class:"activity-log-dot"},null,-1)),a("div",Fe,[a("p",Le,[e[5]||(e[5]=_(" On ")),a("strong",xe,w(Y(s.creation)),1),e[6]||(e[6]=_(", ")),a("strong",Me,w(s.user_name),1),_(" ("+w(s.role)+") ",1),a("strong",Je,w(Z(s.action)),1),e[7]||(e[7]=_(" the request "))])])],2))),128))])])])]),a("div",Ae,[a("div",De,[a("div",Te,[a("div",Ie,[a("div",Ve,[e[12]||(e[12]=a("div",null,[a("h5",{class:"m-0 text-white font-13",id:"exampleModalLabel"},"PDF format")],-1)),a("div",je,[a("button",{button:"button",class:"btn btn-dark text-white font-13",onClick:L},e[10]||(e[10]=[_(" Download Pdf"),a("span",{class:"ms-2"},[a("i",{class:"bi bi-download"})],-1)])),a("button",{type:"button",class:"btn btn-dark text-white font-13",onClick:e[1]||(e[1]=(...s)=>t.closemodal&&t.closemodal(...s)),"data-bs-dismiss":"modal"},e[11]||(e[11]=[_(" Close "),a("i",{class:"bi bi-x"},null,-1)]))])])]),a("div",Be,[a("div",{innerHTML:S.value},null,8,He)]),e[13]||(e[13]=a("div",{class:"modal-footer"},null,-1))])])])]))}},Ge=le(Ue,[["__scopeId","data-v-cff9ce3f"]]);export{Ge as default};
