var de=Object.defineProperty;var I=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var J=(f,r,u)=>r in f?de(f,r,{enumerable:!0,configurable:!0,writable:!0,value:u}):f[r]=u,M=(f,r)=>{for(var u in r||(r={}))me.call(r,u)&&J(f,u,r[u]);if(I)for(var u of I(r))ve.call(r,u)&&J(f,u,r[u]);return f};import{_ as fe,O as pe,u as _e,e as P,d as s,w as ge,o as _,c as g,b as a,t as h,a as W,G as he,P as ye,A as be,B as ke,C as U,i as w,q as N,v as qe,z as we,E as Re,R as Ce,k as y,l as b,n as A}from"./index-BHd6CXej.js";const Se={class:"d-flex justify-content-between align-items-center py-2"},Ne={class:"m-0 font-11 pt-1"},Oe={class:"mt-2"},Le={class:"modal fade",id:"viewRequest","data-bs-backdrop":"static","data-bs-keyboard":"false",tabindex:"-1","aria-labelledby":"viewRequestLabel","aria-hidden":"true"},Pe={class:"modal-dialog modal-dialog-centered modal-lg"},Ae={class:"modal-content"},Ee={class:"modal-header"},$e={class:"modal-title font-13",id:"viewRequestLabel"},Fe={class:"p-2"},Te={class:"activity-log-container"},xe={class:"activity-log-content"},Ve={class:"font-12 mb-1"},Be={class:"strong-content"},De={class:"strong-content"},Ie={class:"strong-content"},Je={key:0},Me={key:1,class:"strong-content"},We={key:0,class:"form-floating p-1"},Ue={key:0,class:"font-11 text-danger ps-1"},je={__name:"HistoryComp",setup(f){const r=pe(),u=_e(),j=P(()=>Re.value),E=s({business_unit:""}),n=s({limitPageLength:20,limit_start:0,filters:[]}),O=s(0),H=s([]),z=s([]),G=s([]);s([]);const Q=s(""),R=s([]),$=s([]);s(!1);const F=s([{th:"Request ID",td_key:"name"},{th:"Requested By",td_key:"requested_by"},{th:"Requested Department",td_key:"role"},{th:"Approval Status",td_key:"status"},{th:"Workflow Status",td_key:"assigned_to_users"},{th:"Linked ID",td_key:"linked_form_id"}]),X=s([{name:"View Request",icon:"fa-solid fa-eye"}]),k=s([]),c=s({}),T=s(null),x=s([]),L=s("");s([]);const Y=s([]);s(!1),s(!1);const V=s([]);function Z(){y.post(b.approvedByMe).then(e=>{V.value=e.message,p()}).catch(e=>{console.log(e)})}function K(e,t){var l,i,o;if(t.name==="View Request")if(e){c.value=M({},e),Q.value=c.value.current_level,T.value=Ce((i=JSON.parse((l=c.value)==null?void 0:l.json_columns))==null?void 0:i.fields),Y.value=JSON.parse((o=c.value)==null?void 0:o.json_columns).child_table_fields;const m=[["wf_generated_request_id","like",`%${c.value.name}%`]],v={fields:JSON.stringify(["*"]),limit_page_length:"None",limit_start:0,filters:JSON.stringify(m),order_by:`\`tab${c.value.doctype_name}\`.\`creation\` desc`};y.get(`${b.resource}${c.value.doctype_name}`,{params:v}).then(d=>{d.data&&(x.value=d.data[0],ne(x.value,T.value),y.get(`${b.resource}${c.value.doctype_name}/${d.data[0].name}`).then(q=>{const D=Object.keys(q.data).filter(S=>Array.isArray(q.data[S]));D.length&&($.value={},D.forEach(S=>{$.value[S]=q.data[S]||[]}))}).catch(q=>{console.error("Error fetching data for :",q)}))}).catch(d=>{console.error("Error fetching categories data:",d)}),y.get(`${b.resource}${A.WFActivityLog}/${c.value.name}`).then(d=>{d.data&&(R.value=d.data.reason||[])}).catch(d=>{console.error("Error fetching activity data:",d)}),new bootstrap.Modal(document.getElementById("viewRequest"),{}).show()}else console.warn(" There is no form fields ")}function ee(e,t,l){l==="view"&&r.push({name:"ApproveRequest",query:{routepath:u.path,name:e.name,doctype_name:e.doctype_name,type:"myapprovals",readOnly:"true"}}),l==="td_key"&&e.linked_form_id&&r.push({name:"ApproveRequest",query:{routepath:u.path,name:e.linked_form_id,business_unit:e.property,type:"linkedForm",readOnly:"true"}})}const te=P(()=>R.value.some(e=>e.action==="Request Cancelled")),se=e=>e?new Date(e).toLocaleDateString("en-GB"):"N/A",ae=e=>e?{"Request Cancelled":"cancelled","Request Raised":"raised"}[e]||e.toLowerCase():"performed an action on",C=s(!0),oe=()=>{L.value.trim()!==""&&(C.value=!0)};function ne(e,t){t.forEach(l=>{l.sections.forEach(i=>{i.rows.forEach(o=>{o.columns.forEach(m=>{m.fields.forEach(v=>{e!=null&&e.hasOwnProperty(v==null?void 0:v.fieldname)&&(v.value=e[v==null?void 0:v.fieldname])})})})})})}function le(){C.value=!0}const ie=e=>{n.value.limitPageLength=e,n.value.limit_start=0,n.value.filters.length?p(n.value.filters):p()},re=([e,t])=>{n.value.limitPageLength=e,n.value.limit_start=t,n.value.filters.length?p(n.value.filters):p()};s([]);const B=s(null);function ue(e){clearTimeout(B.value),B.value=setTimeout(()=>{n.value.filters=[],F.value.forEach(t=>{const l=t.td_key;e[l]&&n.value.filters.push([l,"like",`%${e[l]}%`])}),n.value.filters.length?(n.value.limit_start=0,p(n.value.filters)):p()},500)}function p(e){JSON.parse(localStorage.getItem("employeeData"));const t=[["property","like",`%${E.value.business_unit}%`],["name","in",V.value]];e&&(t.push(...e),console.log(e));const l={fields:JSON.stringify(["*"]),limit_page_length:n.value.limitPageLength,limit_start:n.value.limit_start,filters:JSON.stringify(t),order_by:"`tabWF Workflow Requests`.`creation` desc"},i={fields:JSON.stringify(["count(name) AS total_count"]),limitPageLength:"None",filters:JSON.stringify(t)};y.get(`${b.resource}${A.WFWorkflowRequests}`,{params:i}).then(o=>{O.value=o.data[0].total_count}).catch(o=>{console.error("Error fetching total count:",o)}),y.get(`${b.resource}${A.WFWorkflowRequests}`,{params:l}).then(o=>{n.value.limit_start===0?(k.value=o.data,H.value=[...new Set(o.data.map(m=>m.name))],z.value=[...new Set(o.data.map(m=>m.doctype_name))],G.value=[...new Set(o.data.map(m=>m.status))]):k.value=k.value.concat(o.data)}).catch(o=>{console.error("Error fetching records:",o)})}const ce=P(()=>({name:{type:"input"},requested_by:{type:"input"},role:{type:"input"},status:{type:"select",options:["In Progress","Completed","Request Cancelled"]}}));return ge(j,e=>{E.value.business_unit=e,e.length&&Z()},{immediate:!0}),(e,t)=>{var l;return _(),g("div",null,[a("div",Se,[a("div",null,[t[1]||(t[1]=a("h1",{class:"m-0 font-13"},"My Approval Forms",-1)),a("p",Ne,h(O.value)+" Forms",1)])]),a("div",Oe,[W(he,{tHeaders:F.value,tData:k.value,isAction:"true",viewType:"viewPdf",isCheckbox:"true",onUpdateFilters:ue,"field-mapping":ce.value,onCellClick:ee,isFiltersoption:"true",actions:X.value,onActionClicked:K},null,8,["tHeaders","tData","field-mapping","actions"]),W(ye,{currentRecords:k.value.length,totalRecords:O.value,onUpdateValue:ie,onLimitStart:re},null,8,["currentRecords","totalRecords"])]),a("div",Le,[a("div",Pe,[a("div",Ae,[a("div",Ee,[a("h5",$e," Request Id: "+h((l=c.value.name)==null?void 0:l.replace(/_/g," ")),1),a("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal",onClick:le,"aria-label":"Close"})]),t[8]||(t[8]=a("div",{class:"modal-body approvermodalbody"},null,-1)),a("div",Fe,[a("div",Te,[(_(!0),g(be,null,ke(R.value,(i,o)=>(_(),g("div",{key:o,class:U(["activity-log-item",{"last-item":o===R.value.length-1}])},[t[5]||(t[5]=a("div",{class:"activity-log-dot"},null,-1)),t[6]||(t[6]=w("def add_roles_to_wf_requestors ")),a("div",xe,[a("p",Ve,[t[2]||(t[2]=w(" On ")),a("strong",Be,h(se(i.creation)),1),t[3]||(t[3]=w(", ")),a("strong",De,h(i.user_name),1),w(" ("+h(i.role)+") has ",1),a("strong",Ie,h(ae(i.action)),1),t[4]||(t[4]=w(" the request")),o!==0&&i.reason?(_(),g("span",Je,"with the comments:")):N("",!0),o!==0&&i.reason?(_(),g("strong",Me,h(i.reason||"N/A"),1)):N("",!0)])])],2))),128))]),te.value?N("",!0):(_(),g("div",We,[qe(a("textarea",{class:U(["form-control font-12",{"is-invalid":!C.value}]),placeholder:"Leave a comment here",id:"floatingTextarea",onInput:oe,"onUpdate:modelValue":t[0]||(t[0]=i=>L.value=i)},null,34),[[we,L.value]]),t[7]||(t[7]=a("label",{class:"font-11",for:"floatingTextarea"},"Comments..",-1)),C.value?N("",!0):(_(),g("span",Ue,"Please enter comments**"))]))])])])])])}}},Qe=fe(je,[["__scopeId","data-v-ba48f472"]]);export{Qe as default};
